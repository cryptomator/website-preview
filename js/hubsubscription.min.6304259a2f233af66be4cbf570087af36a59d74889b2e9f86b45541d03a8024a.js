"use strict";const CUSTOM_BILLING_URL=STORE_API_URL+"/hub/custom-billing",GENERATE_PAY_LINK_URL=STORE_API_URL+"/hub/generate-pay-link",SUBSCRIPTION_URL=STORE_API_URL+"/hub/subscription";class HubSubscription{constructor(e,t,n){this._form=e,this._subscriptionData=t,this._subscriptionData.hubId=n.get("hub_id"),this._subscriptionData.hubId&&this._subscriptionData.hubId.length>0&&this.get();let s=n.get("return_url");s&&(this._subscriptionData.returnUrl=decodeURIComponent(s)),this._paddle=$.ajax({url:"https://cdn.paddle.com/paddle/paddle.js",cache:!0,dataType:"script"}).then(()=>(PADDLE_ENABLE_SANDBOX&&window.Paddle.Environment.set("sandbox"),window.Paddle.Setup({vendor:PADDLE_VENDOR_ID}),window.Paddle))}get(){this._subscriptionData.getSuccess=!1,this.determineCustomBilling(()=>{this.loadPrice(()=>{this._subscriptionData.inProgress=!0,this._subscriptionData.errorMessage="",$.ajax({url:SUBSCRIPTION_URL,type:"GET",data:{hub_id:this._subscriptionData.hubId}}).done(e=>{this.onGetSucceeded(e)}).fail(e=>{e.status==404&&e.responseJSON?.status=="error"?this.onGetNotFound():this.onGetFailed(e.responseJSON?.message||"Fetching subscription failed.")})})})}onGetSucceeded(e){this._subscriptionData.token=e.token,this._subscriptionData.details=e.subscription,e.subscription.quantity&&(this._subscriptionData.quantity=e.subscription.quantity),this._subscriptionData.getSuccess=!0,this._subscriptionData.errorMessage="",this._subscriptionData.inProgress=!1}onGetNotFound(){this._subscriptionData.getSuccess=!0,this._subscriptionData.errorMessage="",this._subscriptionData.inProgress=!1}onGetFailed(e){this._subscriptionData.getSuccess=!1,this._subscriptionData.errorMessage=e,this._subscriptionData.inProgress=!1}determineCustomBilling(e){this._subscriptionData.inProgress=!0,this._subscriptionData.errorMessage="",$.ajax({url:CUSTOM_BILLING_URL,type:"GET",data:{hub_id:this._subscriptionData.hubId}}).done(t=>{this.onDetermineCustomBillingSucceeded(t),e()}).fail(t=>{t.status==404&&t.responseJSON?.status=="error"?(this.onDetermineCustomBillingManagedNotFound(),e()):this.onDetermineCustomBillingManagedFailed(t.responseJSON?.message||"Fetching custom billing options failed.")})}onDetermineCustomBillingSucceeded(e){this._subscriptionData.customBilling=e.custom_billing;let t=this._subscriptionData.customBilling.quantity_min;t&&(this._subscriptionData.quantity=t),this._subscriptionData.errorMessage="",this._subscriptionData.inProgress=!1}onDetermineCustomBillingManagedNotFound(){this._subscriptionData.customBilling=null,this._subscriptionData.errorMessage="",this._subscriptionData.inProgress=!1}onDetermineCustomBillingManagedFailed(e){this._subscriptionData.errorMessage=e,this._subscriptionData.inProgress=!1}loadPrice(e){this._subscriptionData.inProgress=!0,this._subscriptionData.errorMessage="";let t;this._subscriptionData.customBilling?.managed?t=PADDLE_HUB_MANAGED_SUBSCRIPTION_PLAN_ID:t=PADDLE_HUB_SELF_HOSTED_SUBSCRIPTION_PLAN_ID,$.ajax({url:PADDLE_PRICES_URL,dataType:"jsonp",data:{product_ids:t}}).done(t=>{this.onLoadPriceSucceeded(t),e()}).fail(e=>{this.onLoadPriceFailed(e.responseJSON?.message||"Loading price failed.")})}onLoadPriceSucceeded(e){let n=e.response.products[0].currency,t;this._subscriptionData.customBilling?.override?.prices?t=this.getAmount(this._subscriptionData.customBilling.override.prices,n)/12:t=e.response.products[0].subscription.price.gross/12,this._subscriptionData.monthlyPrice={amount:t,currency:n},this._subscriptionData.errorMessage="",this._subscriptionData.inProgress=!1}getAmount(e,t){const s=new RegExp(`^${t}:`),n=e.find(e=>s.test(e));return n?parseFloat(n.split(":")[1]):null}onLoadPriceFailed(e){this._subscriptionData.errorMessage=e,this._subscriptionData.inProgress=!1}checkout(e){if(!$(this._form)[0].checkValidity()){$(this._form).find(":input").addClass("show-invalid"),this._subscriptionData.errorMessage="Please fill in all required fields.";return}this._subscriptionData.inProgress=!0,this._subscriptionData.errorMessage="",this._subscriptionData.postSuccess=!1,this._subscriptionData.customBilling?.managed&&this._subscriptionData.customBilling?.override?this.customCheckout(PADDLE_HUB_MANAGED_SUBSCRIPTION_PLAN_ID,e):this._subscriptionData.customBilling?.managed?this.standardCheckout(PADDLE_HUB_MANAGED_SUBSCRIPTION_PLAN_ID,e):this._subscriptionData.customBilling?.override?this.customCheckout(PADDLE_HUB_SELF_HOSTED_SUBSCRIPTION_PLAN_ID,e):this.standardCheckout(PADDLE_HUB_SELF_HOSTED_SUBSCRIPTION_PLAN_ID,e)}standardCheckout(e,t){this._paddle.then(n=>{n.Checkout.open({product:e,email:this._subscriptionData.email,quantity:this._subscriptionData.quantity,locale:t,passthrough:'{"hub_id": '+this._subscriptionData.hubId+"}",successCallback:e=>this.getPaddleOrderDetails(e.checkout.id),closeCallback:()=>{this._subscriptionData.inProgress=!1}})})}customCheckout(e,t){$.ajax({url:GENERATE_PAY_LINK_URL,type:"POST",data:{hub_id:this._subscriptionData.hubId,product_id:e,quantity:this._subscriptionData.quantity}}).done(e=>{this.openPaddleCheckout(e.pay_link,t)}).fail(e=>{this.onPostFailed(e.responseJSON?.message||"Generating pay link failed.")})}openPaddleCheckout(e,t){this._paddle.then(n=>{n.Checkout.open({override:e,email:this._subscriptionData.email,locale:t,passthrough:'{"hub_id": '+this._subscriptionData.hubId+"}",successCallback:e=>this.getPaddleOrderDetails(e.checkout.id),closeCallback:()=>{this._subscriptionData.inProgress=!1}})})}getPaddleOrderDetails(e){this._paddle.then(t=>{t.Order.details(e,e=>{let t=e.order.subscription_id;t?this.post(t):this._subscriptionData.errorMessage="Retrieving subscription failed. Please check your emails instead."})})}post(e){$.ajax({url:SUBSCRIPTION_URL,type:"POST",data:{hub_id:this._subscriptionData.hubId,subscription_id:e}}).done(e=>{this.onPostSucceeded(e)}).fail(e=>{this.onPostFailed(e.responseJSON?.message||"Adding subscription failed.")})}onPostSucceeded(e){this._subscriptionData.token=e.token,this._subscriptionData.details=e.subscription,this._subscriptionData.postSuccess=!0,this._subscriptionData.errorMessage="",this._subscriptionData.inProgress=!1,this._subscriptionData.returnUrl&&window.open(this._subscriptionData.returnUrl+"?token="+e.token,"_self")}onPostFailed(e){this._subscriptionData.postSuccess=!1,this._subscriptionData.errorMessage=e,this._subscriptionData.inProgress=!1}updatePaymentMethod(e){this._subscriptionData.inProgress=!0,this._subscriptionData.errorMessage="",this._paddle.then(t=>{t.Checkout.open({override:this._subscriptionData.details.update_url,locale:e,successCallback:e=>this.get(),closeCallback:()=>{this._subscriptionData.inProgress=!1}})})}pause(){this._subscriptionData.inProgress=!0,this._subscriptionData.errorMessage="",$.ajax({url:SUBSCRIPTION_URL,type:"PUT",data:{hub_id:this._subscriptionData.hubId,pause:!0}}).done(e=>{this.onPutSucceeded(e,!1)}).fail(e=>{this.onPutFailed(e.responseJSON?.message||"Updating subscription failed.")})}askForRestartConfirmation(){this._subscriptionData.restartModal.nextPayment=null,this._subscriptionData.restartModal.open=!0,this.previewRestart()}previewRestart(){this._subscriptionData.inProgress=!0,this._subscriptionData.errorMessage="",$.ajax({url:SUBSCRIPTION_URL,type:"PUT",data:{hub_id:this._subscriptionData.hubId,pause:!1,preview:!0}}).done(e=>{this._subscriptionData.restartModal.nextPayment=e.subscription.next_payment,this._subscriptionData.errorMessage="",this._subscriptionData.inProgress=!1}).fail(e=>{this.onPutFailed(e.responseJSON?.message||"Calculating price failed.")})}restart(){this._subscriptionData.inProgress=!0,this._subscriptionData.errorMessage="",$.ajax({url:SUBSCRIPTION_URL,type:"PUT",data:{hub_id:this._subscriptionData.hubId,pause:!1}}).done(e=>{this.onPutSucceeded(e,!0)}).fail(e=>{this.onPutFailed(e.responseJSON?.message||"Updating subscription failed.")})}openChangeSeatsModal(){this._subscriptionData.quantity=this._subscriptionData.details.quantity,this._subscriptionData.changeSeatsModal.immediatePayment=null,this._subscriptionData.changeSeatsModal.confirmation=!1,this._subscriptionData.changeSeatsModal.open=!0}askForChangeSeatsConfirmation(){if(!$(this._form)[0].checkValidity()){$(this._form).find(":input").addClass("show-invalid"),this._subscriptionData.errorMessage="Please fill in all required fields.";return}this._subscriptionData.changeSeatsModal.confirmation=!0,this.previewChangeQuantity()}previewChangeQuantity(){this._subscriptionData.inProgress=!0,this._subscriptionData.errorMessage="",$.ajax({url:SUBSCRIPTION_URL,type:"PUT",data:{hub_id:this._subscriptionData.hubId,quantity:this._subscriptionData.quantity,preview:!0}}).done(e=>{this._subscriptionData.changeSeatsModal.immediatePayment=e.subscription.immediate_payment,this._subscriptionData.errorMessage="",this._subscriptionData.inProgress=!1}).fail(e=>{this.onPutFailed(e.responseJSON?.message||"Calculating price failed.")})}changeQuantity(){this._subscriptionData.inProgress=!0,this._subscriptionData.errorMessage="",$.ajax({url:SUBSCRIPTION_URL,type:"PUT",data:{hub_id:this._subscriptionData.hubId,quantity:this._subscriptionData.quantity}}).done(e=>{this._subscriptionData.changeSeatsModal.open=!1,this.onPutSucceeded(e,!0)}).fail(e=>{this.onPutFailed(e.responseJSON?.message||"Updating subscription failed.")})}onPutSucceeded(e,t){this._subscriptionData.token=e.token,this._subscriptionData.details=e.subscription,this._subscriptionData.errorMessage="",this._subscriptionData.inProgress=!1,t&&this._subscriptionData.returnUrl&&window.open(this._subscriptionData.returnUrl+"?token="+e.token,"_self")}onPutFailed(e){this._subscriptionData.errorMessage=e,this._subscriptionData.inProgress=!1}}